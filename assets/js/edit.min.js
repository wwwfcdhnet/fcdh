var _ajaxurl="http://www.93ti.com/ajax.php";var _editmodal=$("#edithref");function editHref(url,obj,opt){$('input:radio[name="cate"][value="'+opt+'"]').prop("checked",true);$("#url").html(url);var keys=getHrefKey(url),key=opt+keys,html=localStorage.getItem(key),del=$("#del"),ok=$("#move");if(html!=null){ok.unbind("click").click(function(){optHref(keys,obj,opt)});del.unbind("click").click(function(){localStorage.removeItem(key);obj.remove()})}_editmodal.modal("show")}function optHref(keys,obj,opt){var curopt=$('input:radio[name="cate"]:checked').val(),key=opt+keys,html=localStorage.getItem(key),arr=html.split("@"),max=getMaxLocalNum();if(opt==curopt){html=max+"@"+arr[1]+"@"+curopt+"@"+arr[3]+"@"+arr[4]+"@"+arr[5]+"@"+arr[6]+"@"+arr[7]+"@"+arr[8];localStorage.setItem(key,html);localStorage.setItem("max",++max);var sites=getHtmlDiv(arr,curopt);obj.remove();$("#records"+curopt).prepend(sites)}else{key1=curopt+keys;html=localStorage.getItem(key1);if(html==null){html=max+"@"+arr[1]+"@"+curopt+"@"+arr[3]+"@"+arr[4]+"@"+arr[5]+"@"+arr[6]+"@"+arr[7]+"@"+arr[8];localStorage.setItem(key1,html);localStorage.setItem("max",++max);localStorage.removeItem(key);var temp456=temp7="";var sites=getHtmlDiv(arr,curopt);obj.remove();$("#records"+curopt).prepend(sites)}else{arr=html.split("@");html=max+"@"+arr[1]+"@"+curopt+"@"+arr[3]+"@"+arr[4]+"@"+arr[5]+"@"+arr[6]+"@"+arr[7]+"@"+arr[8];localStorage.setItem(key1,html);localStorage.setItem("max",++max);var warning=$("#warning");warning.find(".modal-body p").html("<strong>网站键值与 "+key1+" 重复!</strong> <br/>按F5刷新查看");warning.modal("show");$("#cancel").prop("hidden",true);$("#ok").attr("value","10");$("#ok").html(" 确定 ")}}}function getHtmlDiv(arr,curopt){var temp456=temp7="";if(arr[7]!="null"){temp7=' class="'+arr[7]+'"'}if(arr[4].indexOf(".")==-1){var temp4=temp5="";if(arr[4]!="null"){temp4=' class="'+arr[4]+'"'}if(arr[5]!="null"){temp5=' class="'+arr[5]+'"'}temp456="<p"+temp4+"><span"+temp5+">"+arr[6]+"</span></p>"}else{temp456='<img src="'+_logo+arr[4]+'">'}var sites='<div class="ti-col" onclick="editHref(\''+arr[1]+"',this,'"+curopt+'\')" title="'+arr[3]+'">'+temp456+"<strong"+temp7+">"+arr[8]+"</strong></div>";return sites}function optSite(obj){var tn=obj.getAttribute("value");var warning=$("#warning");switch(tn){case"0":case"1":var title=$("input[name='title']").val().replace(/^\s*|\s*$/g,"").replace(/@/g,"#"),imgtext=$("input[name='imgtext']").val().replace(/^\s*|\s*$/g,"").substr(0,5).replace(/@/g,"#"),url=$("input[name='url']").val().replace(/^\s*|\s*$/g,"").replace(/@/g,"#"),desc=$("input[name='desc']").val().replace(/^\s*|\s*$/g,"").replace(/@/g,"#"),cname=color=$("select[name='color']").val().replace(/^\s*|\s*$/g,"").replace(/@/g,"#"),bgname=bgcolor=$("select[name='bgcolor']").val().replace(/^\s*|\s*$/g,"").replace(/@/g,"#"),opt=$('input:radio[name="opt"]:checked').val();if(title==""){$("input[name='title']").focus();return}var words=strWords(imgtext);if(imgtext==""){imgtext=title.charAt(0)}if(opt==undefined){opt="1"}var wordclass="";if(words>1){if(words>3){words=3}wordclass=' class="w'+words+'"'}words="w"+words;var key1=null;if(url==""){$("input[name='url']").focus();return}key1=opt+getHrefKey(url);if(color!="null"){color=' class="'+cname+'"'}else{color=""}if(bgcolor!="null"){bgcolor=' class="'+bgname+'"'}else{bgcolor=""}var html1=localStorage.getItem(key1),max=getMaxLocalNum();if(tn=="0"){var imgbg="<p"+bgcolor+"><span"+wordclass+">"+imgtext+"</span></p>",html=max+"@"+url+"@"+opt+"@"+desc+"@"+bgname+"@"+words+"@"+imgtext+"@"+cname+"@"+title;localStorage.setItem(key1,html);localStorage.setItem("max",++max);if(html1==null){$("#records1").prepend('<div class="ti-col" onclick="editHref(\''+url+'\',this,1)" title="'+desc+'">'+imgbg+"<strong"+color+">"+title+"</strong></div>")}else{}warning.modal("hide")}else{if(html1!=null){var arr1=html1.split("@");warning.find(".modal-body p").html("网站键值 "+key1+" 重复!，是否覆盖？<br> <strong>（"+arr1[8]+"）<br>"+arr1[1]+"</strong>");$("#addsite").modal("hide");$("#cancel").prop("hidden",false);$("#ok").attr("value","0");$("#ok").html(" 覆盖 ");var html=max+"@"+arr1[1]+"@"+arr1[2]+"@"+arr1[3]+"@"+arr1[4]+"@"+arr1[5]+"@"+arr1[6]+"@"+arr1[7]+"@"+arr1[8];localStorage.setItem(key1,html);localStorage.setItem("max",++max);warning.modal("show")}else{var imgbg="<p"+bgcolor+"><span"+wordclass+">"+imgtext+"</span></p>";var html=max+"@"+url+"@"+opt+"@"+desc+"@"+bgname+"@"+words+"@"+imgtext+"@"+cname+"@"+title;localStorage.setItem(key1,html);localStorage.setItem("max",++max);var sites='<div class="ti-col" onclick="editHref(\''+url+"',this,"+opt+')" title="'+desc+'">'+imgbg+"<strong"+color+">"+title+"</strong></div>";$("#records"+opt).prepend(sites)}$("#addsite").modal("hide")}break;case"3":var dwname=$("input[name='dwname']").val().replace(/^\s*|\s*$/g,"");if(dwname==""){$("input[name='dwname']").focus();return}var fData=new FormData();fData.append("uname",dwname);var xhr=new XMLHttpRequest();var info=document.getElementById("info");xhr.onreadystatechange=function(){info.innerHTML='<img src="assets/images/loading.gif">';
if(xhr.readyState==4&&xhr.status==200){var strArr=JSON.parse(xhr.responseText);if(strArr["0"]){var max=getMaxLocalNum();var temp6,temp3,temp4,temp345;for(var i=strArr.length-1;i>2;i--){var arr=strArr[i].split("@");var key=arr[1]+getHrefKey(arr[0]);if(localStorage.getItem(key)!=null){continue}temp6="";if(arr[6]!="null"){temp6=' class="'+arr[6]+'"'}if(arr[3].indexOf(".")==-1){temp3=temp4="";if(arr[3]!="null"){temp3=' class="'+arr[3]+'"'}if(arr[4]!="null"){temp4=' class="'+arr[4]+'"'}temp345="<p"+temp3+"><span"+temp4+">"+arr[5]+"</span></p>"}else{temp345='<img src="'+_logo+arr[3]+'">'}localStorage.setItem(key,max+"@"+strArr[i]);++max;var sites='<div class="ti-col" onclick="editHref(\''+arr[0]+"',this,"+arr[1]+')" title="'+arr[2]+'">'+temp345+"<strong"+temp6+">"+arr[7]+"</strong></div>";$("#records"+arr[1]).prepend(sites)}localStorage.setItem("max",max);info.innerHTML=strArr["1"]}else{info.innerHTML=strArr["2"]}}if(xhr.status==500||xhr.status==502||xhr.status==503||xhr.status==504){info.innerHTML="下载失败!"}};xhr.open("POST",_ajaxurl);xhr.send(fData);$("#downsite").modal("hide");break;case"4":var upname=$("input[name='upname']").val().replace(/^\s*|\s*$/g,""),psw=$("input[name='psw']").val();if(upname==""){$("input[name='upname']").focus();return}if(psw==""){$("input[name='psw']").focus();return}var strArr=[],first="0";strArr.push(upname);strArr.push(psw);for(var i=0,len=localStorage.length;i<len;i++){var key=localStorage.key(i);first=key.charAt(0);if(key=="max"||key=="search"||key=="cate"||first=="0"){continue}strArr.push(localStorage.getItem(key).replace(/^\s*|\s*$/g,"")+"@"+key)}var jsonstr=JSON.stringify(strArr);var fData=new FormData();fData.append("upstr",jsonstr);var xhr=new XMLHttpRequest();var info=document.getElementById("info");xhr.onreadystatechange=function(){info.innerHTML='<img src="assets/images/loading.gif">';if(xhr.readyState==4&&xhr.status==200){var strArr=JSON.parse(xhr.responseText);if(strArr["0"]){info.innerHTML=strArr["1"]}else{info.innerHTML=strArr["2"]}}if(xhr.status==500||xhr.status==502||xhr.status==503||xhr.status==504){info.innerHTML="上传失败!"}};xhr.open("POST",_ajaxurl);xhr.send(fData);$("#upsite").modal("hide");break;case"9":localStorage.clear();document.getElementById("records0").innerHTML="";document.getElementById("records1").innerHTML="";document.getElementById("records2").innerHTML="";document.getElementById("records3").innerHTML="";document.getElementById("records4").innerHTML="";document.getElementById("records5").innerHTML="";warning.modal("hide");break;default:warning.modal("hide")}}function clearRecords(){var warning=$("#warning");warning.find(".modal-body p").html("单击“确定”清除记录。单击“取消”返回。");$("#ok").html(" 确定 ");$("#ok").attr("value","9");warning.modal("show");return}function strWords(str){var words=chars=len=0;for(var i=0;i<str.length;i++){if(str.charCodeAt(i)>127||str.charCodeAt(i)==94){len+=2;words++}else{chars++;len+=1}}if(len<1){return 0}else{if(len<3){return 1}else{if(len==3){return 2}else{if(len==4){if(words==0){return 3}else{return 2}}else{return 3}}}}};